# ======================================================
# üêç 1Ô∏è‚É£ Use a lightweight Python base image
# ======================================================
FROM python:3.10-slim

# ======================================================
# üìÇ 2Ô∏è‚É£ Set working directory
# ======================================================
WORKDIR /app

# ======================================================
# üß© 3Ô∏è‚É£ Copy project files into the container
# ======================================================
COPY . .

# ======================================================
# ‚öôÔ∏è 4Ô∏è‚É£ Install system dependencies for OpenCV, YOLO, ffmpeg
# ======================================================
RUN apt-get update && apt-get install -y \
    libgl1 \
    libglib2.0-0 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# ======================================================
# üì¶ 5Ô∏è‚É£ Install Python dependencies
# Use --no-cache-dir to reduce image size
# ======================================================
RUN pip install --no-cache-dir -r requirements.txt

# ======================================================
# üß† 6Ô∏è‚É£ Environment optimizations
# ======================================================
# Prevent Python from buffering logs
ENV PYTHONUNBUFFERED=1

# Prevent Ultralytics from writing to non-writable /opt path
ENV YOLO_CONFIG_DIR=/tmp/Ultralytics

# Optional: limit upload size (e.g., 15 MB max)
ENV MAX_CONTENT_LENGTH=15728640

# ======================================================
# üåê 7Ô∏è‚É£ Expose the Flask port
# ======================================================
EXPOSE 5000

# ======================================================
# üöÄ 8Ô∏è‚É£ Run the app with Gunicorn (stable for Render/Railway)
# ======================================================
CMD gunicorn flask_api:app \
    --workers=1 \
    --threads=1 \
    --timeout=300 \
    --bind 0.0.0.0:$PORT
